name: Publish to Maven Central

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Generate settings.xml
        uses: s4u/maven-settings-action@v2
        with:
          servers: |
            [
              {
                "id": "central",
                "username": "${{ secrets.OSSRH_USERNAME }}",
                "password": "${{ secrets.OSSRH_PASSWORD }}"
              }
            ]
      - name: Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" | base64 --decode > private.key
          gpg --batch --import private.key
          rm private.key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: List GPG keys
        run: gpg --list-secret-keys --keyid-format LONG

      - name: Verify GPG key is usable
        run: echo "test" | gpg --clearsign

      - name: Deploy to Maven Central
        run: mvn clean deploy -P central